<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DamasPro - Gestion de Damas y Tesoreria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .sidebar-item {
            transition: all 0.3s ease;
        }
        
        .sidebar-item:hover, .sidebar-item.active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .fade-in {
            animation: fadeIn 0.4s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-active { background: #10b981; }
        .status-inactive { background: #ef4444; }
        
        .transaction-income { color: #10b981; }
        .transaction-expense { color: #ef4444; }
        
        .limit-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .limit-reached { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    </style>
</head>
<body class="p-4 md:p-6">

    <!-- Header Mobile -->
    <div class="md:hidden glass-effect rounded-xl p-4 mb-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-pink-600 rounded-lg flex items-center justify-center text-white">
                <i class="fas fa-female"></i>
            </div>
            <div>
                <h1 class="font-bold text-gray-800">DamasPro</h1>
                <p class="text-xs text-gray-600">Gestion Integral</p>
            </div>
        </div>
        <button onclick="toggleMobileMenu()" class="text-gray-700 text-xl">
            <i class="fas fa-bars"></i>
        </button>
    </div>

    <div class="max-w-7xl mx-auto flex gap-6">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="hidden md:block w-64 glass-effect rounded-2xl p-4 h-fit sticky top-6">
            <div class="hidden md:flex items-center gap-3 mb-8 px-2">
                <div class="w-12 h-12 bg-pink-600 rounded-xl flex items-center justify-center text-white text-xl">
                    <i class="fas fa-female"></i>
                </div>
                <div>
                    <h1 class="font-bold text-gray-800 text-lg">DamasPro</h1>
                    <p class="text-xs text-gray-600">Gestion y Tesoreria</p>
                </div>
            </div>

            <nav class="space-y-2">
                <button onclick="showSection('dashboard')" id="nav-dashboard" class="sidebar-item active w-full text-left px-4 py-3 rounded-xl text-gray-700 flex items-center gap-3">
                    <i class="fas fa-home w-5"></i>
                    <span>Dashboard</span>
                </button>
                
                <button onclick="showSection('damas')" id="nav-damas" class="sidebar-item w-full text-left px-4 py-3 rounded-xl text-gray-700 flex items-center gap-3">
                    <i class="fas fa-users w-5"></i>
                    <span>Damas</span>
                    <span id="count-damas" class="ml-auto bg-pink-100 text-pink-600 text-xs font-bold px-2 py-1 rounded-full">0</span>
                </button>
                
                <button onclick="showSection('tesoreria')" id="nav-tesoreria" class="sidebar-item w-full text-left px-4 py-3 rounded-xl text-gray-700 flex items-center gap-3">
                    <i class="fas fa-hand-holding-usd w-5"></i>
                    <span>Tesoreria</span>
                </button>
                
                <button onclick="showSection('reportes')" id="nav-reportes" class="sidebar-item w-full text-left px-4 py-3 rounded-xl text-gray-700 flex items-center gap-3">
                    <i class="fas fa-chart-pie w-5"></i>
                    <span>Reportes</span>
                </button>
                
                <div class="pt-4 border-t border-gray-200 mt-4">
                    <button onclick="showSection('config')" id="nav-config" class="sidebar-item w-full text-left px-4 py-3 rounded-xl text-gray-700 flex items-center gap-3">
                        <i class="fas fa-cog w-5"></i>
                        <span>Configuracion</span>
                    </button>
                </div>
            </nav>

            <!-- Limit Indicator -->
            <div class="mt-6 p-3 bg-gradient-to-r from-pink-50 to-purple-50 rounded-xl border border-pink-200">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-semibold text-gray-600">Plan Gratuito</span>
                    <i class="fas fa-gift text-pink-500"></i>
                </div>
                <div class="text-2xl font-bold text-gray-800 mb-1">
                    <span id="sidebarCount">0</span>/100
                </div>
                <div class="text-xs text-gray-500 mb-2">miembros registrados</div>
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="sidebarProgress" class="h-full bg-pink-500 transition-all duration-500" style="width: 0%"></div>
                </div>
                <button onclick="showUpgradeModal()" class="mt-3 w-full text-xs bg-pink-600 text-white py-2 rounded-lg hover:bg-pink-700 transition">
                    Actualizar a Pro
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1">
            
            <!-- DASHBOARD SECTION -->
            <section id="section-dashboard" class="fade-in">
                <div class="glass-effect rounded-2xl p-6 mb-6 shadow-xl">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Hola, Tesorera!</h2>
                            <p class="text-gray-600">Resumen general del ministerio de damas</p>
                        </div>
                        <button onclick="window.print()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition flex items-center gap-2">
                            <i class="fas fa-print"></i>
                            <span class="hidden sm:inline">Imprimir</span>
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="glass-effect rounded-xl p-4 card-hover">
                        <div class="flex items-center justify-between mb-2">
                            <div class="w-10 h-10 bg-pink-100 rounded-lg flex items-center justify-center text-pink-600">
                                <i class="fas fa-female"></i>
                            </div>
                            <span class="text-xs text-gray-500">Total Damas</span>
                        </div>
                        <p class="text-2xl font-bold text-gray-800" id="dashTotalDamas">0</p>
                    </div>

                    <div class="glass-effect rounded-xl p-4 card-hover">
                        <div class="flex items-center justify-between mb-2">
                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center text-green-600">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <span class="text-xs text-gray-500">Activas</span>
                        </div>
                        <p class="text-2xl font-bold text-green-600" id="dashActivas">0</p>
                    </div>

                    <div class="glass-effect rounded-xl p-4 card-hover">
                        <div class="flex items-center justify-between mb-2">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <span class="text-xs text-gray-500">Balance</span>
                        </div>
                        <p class="text-xl font-bold text-blue-600" id="dashBalance">$0</p>
                    </div>

                    <div class="glass-effect rounded-xl p-4 card-hover">
                        <div class="flex items-center justify-between mb-2">
                            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center text-purple-600">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <span class="text-xs text-gray-500">Este Mes</span>
                        </div>
                        <p class="text-xl font-bold text-purple-600" id="dashMes">$0</p>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div class="glass-effect rounded-xl p-6">
                        <h3 class="font-bold text-gray-800 mb-4">Acciones Rapidas</h3>
                        <div class="space-y-3">
                            <button onclick="showSection('damas'); setTimeout(openDamaModal, 100)" class="w-full p-3 bg-pink-50 text-pink-700 rounded-lg hover:bg-pink-100 transition flex items-center gap-3">
                                <i class="fas fa-user-plus"></i>
                                Registrar Nueva Dama
                            </button>
                            <button onclick="showSection('tesoreria'); setTimeout(openTransaccionModal, 100)" class="w-full p-3 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition flex items-center gap-3">
                                <i class="fas fa-plus-circle"></i>
                                Registrar Ofrenda/Diezmo
                            </button>
                            <button onclick="showSection('tesoreria')" class="w-full p-3 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition flex items-center gap-3">
                                <i class="fas fa-file-invoice-dollar"></i>
                                Ver Balance General
                            </button>
                        </div>
                    </div>

                    <div class="glass-effect rounded-xl p-6">
                        <h3 class="font-bold text-gray-800 mb-4">Actividad Reciente</h3>
                        <div id="recentActivity" class="space-y-3 max-h-48 overflow-y-auto">
                            <p class="text-gray-500 text-sm text-center py-4">No hay actividad reciente</p>
                        </div>
                    </div>
                </div>

                <!-- Mini Chart -->
                <div class="glass-effect rounded-xl p-6">
                    <h3 class="font-bold text-gray-800 mb-4">Ingresos vs Egresos (Ultimos 6 meses)</h3>
                    <canvas id="miniChart" height="100"></canvas>
                </div>
            </section>

            <!-- DAMAS SECTION -->
            <section id="section-damas" class="hidden fade-in">
                <div class="glass-effect rounded-2xl p-6 mb-6 shadow-xl flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Registro de Damas</h2>
                        <p class="text-gray-600">Gestion de membresia femenina</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="exportarDamasExcel()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                            <i class="fas fa-file-excel"></i>
                            Excel
                        </button>
                        <button onclick="openDamaModal()" class="px-6 py-3 bg-pink-600 text-white rounded-xl hover:bg-pink-700 transition flex items-center gap-2 shadow-lg">
                            <i class="fas fa-plus"></i>
                            Nueva Dama
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="glass-effect rounded-xl p-4 mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1 relative">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" id="searchDamas" placeholder="Buscar por nombre..." 
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                                   oninput="renderDamas()">
                        </div>
                        <select id="filterEstado" onchange="renderDamas()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                            <option value="">Todos los estados</option>
                            <option value="activa">Activa</option>
                            <option value="inactiva">Inactiva</option>
                        </select>
                        <select id="filterCargo" onchange="renderDamas()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                            <option value="">Todos los cargos</option>
                            <option value="presidenta">Presidenta</option>
                            <option value="vicepresidenta">Vicepresidenta</option>
                            <option value="secretaria">Secretaria</option>
                            <option value="tesorera">Tesorera</option>
                            <option value="coordinadora">Coordinadora</option>
                            <option value="miembro">Miembro</option>
                        </select>
                    </div>
                </div>

                <!-- Damas Grid -->
                <div id="damasGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Damas inserted here -->
                </div>
            </section>

            <!-- TESORERIA SECTION -->
            <section id="section-tesoreria" class="hidden fade-in">
                <div class="glass-effect rounded-2xl p-6 mb-6 shadow-xl flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Tesoreria</h2>
                        <p class="text-gray-600">Control de finanzas del ministerio</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="exportarFinanzas()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                            <i class="fas fa-file-excel"></i>
                            Excel
                        </button>
                        <button onclick="openTransaccionModal()" class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition flex items-center gap-2 shadow-lg">
                            <i class="fas fa-plus"></i>
                            Nueva Transaccion
                        </button>
                    </div>
                </div>

                <!-- Financial Summary -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="glass-effect rounded-xl p-6 card-hover border-l-4 border-green-500">
                        <p class="text-sm text-gray-600 mb-1">Total Ingresos</p>
                        <p class="text-3xl font-bold text-green-600" id="totalIngresos">$0.00</p>
                        <p class="text-xs text-gray-500 mt-2">Desde el inicio</p>
                    </div>

                    <div class="glass-effect rounded-xl p-6 card-hover border-l-4 border-red-500">
                        <p class="text-sm text-gray-600 mb-1">Total Egresos</p>
                        <p class="text-3xl font-bold text-red-600" id="totalEgresos">$0.00</p>
                        <p class="text-xs text-gray-500 mt-2">Gastos operativos</p>
                    </div>

                    <div class="glass-effect rounded-xl p-6 card-hover border-l-4 border-blue-500">
                        <p class="text-sm text-gray-600 mb-1">Balance Actual</p>
                        <p class="text-3xl font-bold text-blue-600" id="balanceActual">$0.00</p>
                        <p class="text-xs text-gray-500 mt-2">Disponible en caja</p>
                    </div>
                </div>

                <!-- Transactions Table -->
                <div class="glass-effect rounded-xl p-6 overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-800">Historial de Transacciones</h3>
                        <div class="flex gap-2">
                            <input type="month" id="filterMonth" onchange="renderTransacciones()" class="px-3 py-1 border border-gray-300 rounded-lg text-sm">
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-gray-600 text-sm uppercase">
                                <tr>
                                    <th class="px-4 py-3">Fecha</th>
                                    <th class="px-4 py-3">Concepto</th>
                                    <th class="px-4 py-3">Categoria</th>
                                    <th class="px-4 py-3">Miembro</th>
                                    <th class="px-4 py-3 text-right">Monto</th>
                                    <th class="px-4 py-3 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="transaccionesTable" class="divide-y divide-gray-100">
                                <!-- Transactions here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- REPORTES SECTION -->
            <section id="section-reportes" class="hidden fade-in">
                <div class="glass-effect rounded-2xl p-6 mb-6 shadow-xl flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Reportes y Estadisticas</h2>
                        <p class="text-gray-600">Analisis completo del ministerio</p>
                    </div>
                    <button onclick="window.print()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition flex items-center gap-2">
                        <i class="fas fa-print"></i>
                        Imprimir Reporte
                    </button>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div class="glass-effect rounded-xl p-6">
                        <h3 class="font-bold text-gray-800 mb-4">Crecimiento de Damas</h3>
                        <canvas id="chartCrecimiento"></canvas>
                    </div>

                    <div class="glass-effect rounded-xl p-6">
                        <h3 class="font-bold text-gray-800 mb-4">Ingresos por Categoria</h3>
                        <canvas id="chartCategorias"></canvas>
                    </div>

                    <div class="glass-effect rounded-xl p-6">
                        <h3 class="font-bold text-gray-800 mb-4">Asistencia Estimada</h3>
                        <canvas id="chartAsistencia"></canvas>
                    </div>

                    <div class="glass-effect rounded-xl p-6">
                        <h3 class="font-bold text-gray-800 mb-4">Proyeccion Financiera</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                <span class="text-green-800">Proyeccion Mensual</span>
                                <span class="font-bold text-green-600" id="proyeccionMensual">$0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                <span class="text-blue-800">Promedio por Miembro</span>
                                <span class="font-bold text-blue-600" id="promedioMiembro">$0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                                <span class="text-purple-800">Anual Estimado</span>
                                <span class="font-bold text-purple-600" id="estimadoAnual">$0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resumen Ejecutivo -->
                <div class="mt-6 glass-effect rounded-xl p-6">
                    <h3 class="font-bold text-gray-800 mb-4">Resumen Ejecutivo para el Pastor</h3>
                    <div id="resumenEjecutivo" class="text-gray-700 space-y-2">
                        <!-- Generated content -->
                    </div>
                </div>
            </section>

            <!-- CONFIG SECTION -->
            <section id="section-config" class="hidden fade-in">
                <div class="glass-effect rounded-2xl p-6 mb-6 shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-800">Configuracion</h2>
                    <p class="text-gray-600">Personaliza tu cuenta</p>
                </div>

                <div class="glass-effect rounded-xl p-6 max-w-2xl">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Ministerio</label>
                            <input type="text" id="configNombre" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de la Tesorera</label>
                            <input type="text" id="configTesorera" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Moneda</label>
                            <select id="configMoneda" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                                <option value="USD">USD - Dolares</option>
                                <option value="MXN">MXN - Pesos Mexicanos</option>
                                <option value="COP">COP - Pesos Colombianos</option>
                                <option value="ARS">ARS - Pesos Argentinos</option>
                                <option value="EUR">EUR - Euros</option>
                            </select>
                        </div>

                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                            <div>
                                <h4 class="font-medium text-gray-800">Respaldo de Datos</h4>
                                <p class="text-sm text-gray-600">Exporta todos tus datos</p>
                            </div>
                            <button onclick="backupCompleto()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                                Descargar JSON
                            </button>
                        </div>

                        <button onclick="guardarConfig()" class="w-full py-3 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition font-medium">
                            Guardar Cambios
                        </button>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- MODALS -->

    <!-- Dama Modal -->
    <div id="damaModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center rounded-t-2xl">
                <h3 class="text-xl font-bold text-gray-800" id="damaModalTitle">Nueva Dama</h3>
                <button onclick="closeDamaModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="damaForm" class="p-6 space-y-4" onsubmit="saveDama(event)">
                <input type="hidden" id="damaId">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                        <input type="text" id="damaNombre" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Apellido *</label>
                        <input type="text" id="damaApellido" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Telefono</label>
                        <input type="tel" id="damaTelefono" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="damaEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Nacimiento</label>
                        <input type="date" id="damaNacimiento" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Ingreso</label>
                        <input type="date" id="damaIngreso" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cargo</label>
                        <select id="damaCargo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                            <option value="miembro">Miembro</option>
                            <option value="presidenta">Presidenta</option>
                            <option value="vicepresidenta">Vicepresidenta</option>
                            <option value="secretaria">Secretaria</option>
                            <option value="tesorera">Tesorera</option>
                            <option value="coordinadora">Coordinadora</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                        <select id="damaEstado" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                            <option value="activa">Activa</option>
                            <option value="inactiva">Inactiva</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Direccion</label>
                    <textarea id="damaDireccion" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                    <textarea id="damaNotas" rows="2" placeholder="Informacion pastoral, talentos, etc..." 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"></textarea>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeDamaModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 font-medium">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transaccion Modal -->
    <div id="transaccionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl shadow-2xl w-full max-w-lg">
            <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center rounded-t-2xl">
                <h3 class="text-xl font-bold text-gray-800">Nueva Transaccion</h3>
                <button onclick="closeTransaccionModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="transaccionForm" class="p-6 space-y-4" onsubmit="saveTransaccion(event)">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo *</label>
                        <select id="transTipo" required onchange="updateTransaccionForm()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="ingreso">Ingreso</option>
                            <option value="egreso">Egreso</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha *</label>
                        <input type="date" id="transFecha" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Monto *</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2 text-gray-500" id="transMonedaSymbol">$</span>
                        <input type="number" id="transMonto" required step="0.01" min="0.01" 
                               class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Concepto *</label>
                    <input type="text" id="transConcepto" required placeholder="Ej: Ofrenda dominical" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoria *</label>
                    <select id="transCategoria" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="ofrenda">Ofrenda</option>
                        <option value="diezmo">Diezmo</option>
                        <option value="donacion">Donacion Especial</option>
                        <option value="evento">Evento/Actividad</option>
                        <option value="cuota">Cuota Membresia</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Registrado por</label>
                    <select id="transMiembro" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccionar dama...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                    <textarea id="transNotas" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeTransaccionModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                        Registrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl shadow-2xl w-full max-w-2xl">
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-3">
                        <i class="fas fa-crown"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">Actualizar a DamasPro Premium</h3>
                    <p class="text-gray-600">Has alcanzado el limite de 100 damas</p>
                </div>

                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div class="border-2 border-gray-200 rounded-xl p-4">
                        <h4 class="font-bold text-gray-700 mb-2">Gratis</h4>
                        <div class="text-3xl font-bold text-gray-800 mb-4">$0</div>
                        <ul class="space-y-2 text-sm text-gray-600">
                            <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i> 100 damas</li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i> Tesoreria basica</li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i> Reportes simples</li>
                        </ul>
                    </div>
                    
                    <div class="border-2 border-pink-500 rounded-xl p-4 bg-pink-50 relative">
                        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-pink-500 to-purple-600 text-white text-xs font-bold px-3 py-1 rounded-full">
                            RECOMENDADO
                        </div>
                        <h4 class="font-bold text-pink-900 mb-2">Premium</h4>
                        <div class="text-3xl font-bold text-pink-600 mb-1">$19<span class="text-lg text-gray-600">/mes</span></div>
                        <p class="text-xs text-gray-500 mb-4">Perfecto para iglesias en crecimiento</p>
                        <ul class="space-y-2 text-sm text-gray-700">
                            <li class="flex items-center gap-2"><i class="fas fa-check text-pink-600"></i> <strong>Damas ilimitadas</strong></li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-pink-600"></i> Tesoreria avanzada</li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-pink-600"></i> Reportes PDF descargables</li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-pink-600"></i> Graficos avanzados</li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-pink-600"></i> Backup automatico</li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-pink-600"></i> Soporte prioritario</li>
                        </ul>
                    </div>
                </div>

                <div class="space-y-3">
                    <button onclick="simulateUpgrade()" class="w-full py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-lg font-bold hover:opacity-90 transition shadow-lg">
                        Comenzar Prueba Gratis 14 dias
                    </button>
                    <button onclick="closeUpgradeModal()" class="w-full py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                        Seguir con plan gratuito
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACION Y DATOS
        const FREE_LIMIT = 100;
        
        let damas = JSON.parse(localStorage.getItem('damasData')) || [];
        let transacciones = JSON.parse(localStorage.getItem('transaccionesData')) || [];
        let config = JSON.parse(localStorage.getItem('damasConfig')) || {
            nombreMinisterio: 'Ministerio de Damas',
            nombreTesorera: '',
            moneda: 'USD'
        };
        let isPro = localStorage.getItem('damasPro') === 'true';

        // INICIALIZACION
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DamasPro cargado');
            
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('damaIngreso').value = hoy;
            document.getElementById('transFecha').value = hoy;
            document.getElementById('filterMonth').value = hoy.slice(0, 7);
            
            document.getElementById('configNombre').value = config.nombreMinisterio;
            document.getElementById('configTesorera').value = config.nombreTesorera;
            document.getElementById('configMoneda').value = config.moneda;
            
            updateMonedaSymbol();
            updateUI();
            initCharts();
            renderDamas();
            updateTesoreriaStats();
            renderTransacciones();
        });

        // NAVEGACION
        function showSection(sectionName) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById('section-' + sectionName).classList.remove('hidden');
            
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            document.getElementById('nav-' + sectionName).classList.add('active');
            
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.add('hidden');
            sidebar.classList.remove('fixed', 'inset-0', 'z-40', 'w-full');
            
            if (sectionName === 'damas') renderDamas();
            if (sectionName === 'tesoreria') {
                updateTesoreriaStats();
                renderTransacciones();
            }
            if (sectionName === 'reportes') updateReportes();
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('hidden')) {
                sidebar.classList.remove('hidden');
                sidebar.classList.add('fixed', 'inset-0', 'z-40', 'w-full');
            } else {
                sidebar.classList.add('hidden');
                sidebar.classList.remove('fixed', 'inset-0', 'z-40', 'w-full');
            }
        }

        // ACTUALIZACION DE UI
        function updateUI() {
            document.getElementById('dashTotalDamas').textContent = damas.length;
            document.getElementById('dashActivas').textContent = damas.filter(d => d.estado === 'activa').length;
            document.getElementById('count-damas').textContent = damas.length;
            document.getElementById('sidebarCount').textContent = damas.length;
            
            const totalIngresos = transacciones.filter(t => t.tipo === 'ingreso').reduce((sum, t) => sum + parseFloat(t.monto), 0);
            const totalEgresos = transacciones.filter(t => t.tipo === 'egreso').reduce((sum, t) => sum + parseFloat(t.monto), 0);
            const balance = totalIngresos - totalEgresos;
            
            document.getElementById('dashBalance').textContent = formatMoney(balance);
            
            const mesActual = new Date().toISOString().slice(0, 7);
            const ingresosMes = transacciones.filter(t => t.tipo === 'ingreso' && t.fecha.startsWith(mesActual)).reduce((sum, t) => sum + parseFloat(t.monto), 0);
            document.getElementById('dashMes').textContent = formatMoney(ingresosMes);
            
            const porcentaje = Math.min((damas.length / FREE_LIMIT) * 100, 100);
            document.getElementById('sidebarProgress').style.width = porcentaje + '%';
            
            updateRecentActivity();
        }

        function updateRecentActivity() {
            const container = document.getElementById('recentActivity');
            const actividades = [
                ...damas.slice(-3).map(d => ({tipo: 'dama', fecha: d.createdAt, data: d})),
                ...transacciones.slice(-3).map(t => ({tipo: 'transaccion', fecha: t.createdAt, data: t}))
            ].sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).slice(0, 5);
            
            if (actividades.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No hay actividad reciente</p>';
                return;
            }
            
            container.innerHTML = actividades.map(act => {
                if (act.tipo === 'dama') {
                    return `<div class="flex items-center gap-3 p-2 bg-pink-50 rounded-lg">
                        <div class="w-8 h-8 bg-pink-200 rounded-full flex items-center justify-center text-pink-700 text-xs"><i class="fas fa-female"></i></div>
                        <div class="flex-1"><p class="text-sm font-medium text-gray-800">Nueva dama: ${act.data.nombre} ${act.data.apellido}</p><p class="text-xs text-gray-500">${formatDate(act.fecha)}</p></div>
                    </div>`;
                } else {
                    const esIngreso = act.data.tipo === 'ingreso';
                    return `<div class="flex items-center gap-3 p-2 bg-${esIngreso ? 'green' : 'red'}-50 rounded-lg">
                        <div class="w-8 h-8 bg-${esIngreso ? 'green' : 'red'}-200 rounded-full flex items-center justify-center text-${esIngreso ? 'green' : 'red'}-700 text-xs"><i class="fas fa-${esIngreso ? 'arrow-up' : 'arrow-down'}"></i></div>
                        <div class="flex-1"><p class="text-sm font-medium text-gray-800">${act.data.concepto}</p><p class="text-xs text-${esIngreso ? 'green' : 'red'}-600 font-bold">${esIngreso ? '+' : '-'}${formatMoney(act.data.monto)}</p></div>
                    </div>`;
                }
            }).join('');
        }

        // GESTION DE DAMAS
        function openDamaModal(id = null) {
            const modal = document.getElementById('damaModal');
            const form = document.getElementById('damaForm');
            const title = document.getElementById('damaModalTitle');
            
            form.reset();
            document.getElementById('damaId').value = '';
            document.getElementById('damaIngreso').value = new Date().toISOString().split('T')[0];
            
            if (id) {
                const dama = damas.find(d => d.id === id);
                if (dama) {
                    title.textContent = 'Editar Dama';
                    document.getElementById('damaId').value = dama.id;
                    document.getElementById('damaNombre').value = dama.nombre;
                    document.getElementById('damaApellido').value = dama.apellido;
                    document.getElementById('damaTelefono').value = dama.telefono || '';
                    document.getElementById('damaEmail').value = dama.email || '';
                    document.getElementById('damaNacimiento').value = dama.nacimiento || '';
                    document.getElementById('damaIngreso').value = dama.ingreso || '';
                    document.getElementById('damaCargo').value = dama.cargo || 'miembro';
                    document.getElementById('damaEstado').value = dama.estado || 'activa';
                    document.getElementById('damaDireccion').value = dama.direccion || '';
                    document.getElementById('damaNotas').value = dama.notas || '';
                }
            } else {
                title.textContent = 'Nueva Dama';
            }
            
            modal.classList.remove('hidden');
        }

        function closeDamaModal() {
            document.getElementById('damaModal').classList.add('hidden');
        }

        function saveDama(event) {
            event.preventDefault();
            
            const id = document.getElementById('damaId').value;
            const esEdicion = id !== '';
            
            if (!esEdicion && damas.length >= FREE_LIMIT && !isPro) {
                closeDamaModal();
                showUpgradeModal();
                return;
            }
            
            const damaData = {
                id: id || Date.now().toString(),
                nombre: document.getElementById('damaNombre').value,
                apellido: document.getElementById('damaApellido').value,
                telefono: document.getElementById('damaTelefono').value,
                email: document.getElementById('damaEmail').value,
                nacimiento: document.getElementById('damaNacimiento').value,
                ingreso: document.getElementById('damaIngreso').value,
                cargo: document.getElementById('damaCargo').value,
                estado: document.getElementById('damaEstado').value,
                direccion: document.getElementById('damaDireccion').value,
                notas: document.getElementById('damaNotas').value,
                createdAt: esEdicion ? damas.find(d => d.id === id).createdAt : new Date().toISOString()
            };
            
            if (esEdicion) {
                const index = damas.findIndex(d => d.id === id);
                damas[index] = damaData;
            } else {
                damas.push(damaData);
            }
            
            localStorage.setItem('damasData', JSON.stringify(damas));
            closeDamaModal();
            renderDamas();
            updateUI();
            showNotification('Dama guardada exitosamente', 'success');
        }

        function deleteDama(id) {
            if (!confirm('Estas segura de eliminar esta dama del registro?')) return;
            
            damas = damas.filter(d => d.id !== id);
            localStorage.setItem('damasData', JSON.stringify(damas));
            renderDamas();
            updateUI();
            showNotification('Dama eliminada', 'info');
        }

        function renderDamas() {
            const grid = document.getElementById('damasGrid');
            const busqueda = document.getElementById('searchDamas').value.toLowerCase();
            const filtroEstado = document.getElementById('filterEstado').value;
            const filtroCargo = document.getElementById('filterCargo').value;
            
            let filtradas = damas.filter(dama => {
                const coincideBusqueda = (dama.nombre + ' ' + dama.apellido).toLowerCase().includes(busqueda);
                const coincideEstado = !filtroEstado || dama.estado === filtroEstado;
                const coincideCargo = !filtroCargo || dama.cargo === filtroCargo;
                return coincideBusqueda && coincideEstado && coincideCargo;
            });
            
            if (filtradas.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-12"><i class="fas fa-search text-4xl text-gray-300 mb-4"></i><p class="text-gray-500">No se encontraron damas</p><button onclick="openDamaModal()" class="mt-4 text-pink-600 hover:text-pink-800 font-medium">Agregar la primera dama</button></div>`;
                return;
            }
            
            const cargos = {
                presidenta: 'Presidenta',
                vicepresidenta: 'Vicepresidenta',
                secretaria: 'Secretaria',
                tesorera: 'Tesorera',
                coordinadora: 'Coordinadora',
                miembro: 'Miembro'
            };
            
            grid.innerHTML = filtradas.map(dama => `
                <div class="glass-effect rounded-xl p-5 card-hover">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-pink-500 rounded-full flex items-center justify-center text-white font-bold text-lg">${dama.nombre[0]}${dama.apellido[0]}</div>
                            <div>
                                <h3 class="font-bold text-gray-800">${dama.nombre} ${dama.apellido}</h3>
                                <span class="inline-block px-2 py-1 bg-pink-100 text-pink-700 text-xs rounded-full mt-1">${cargos[dama.cargo] || 'Miembro'}</span>
                            </div>
                        </div>
                        <div class="w-3 h-3 rounded-full ${dama.estado === 'activa' ? 'bg-green-500' : 'bg-red-500'}"></div>
                    </div>
                    <div class="space-y-2 text-sm text-gray-600 mb-4">
                        ${dama.telefono ? `<div class="flex items-center gap-2"><i class="fas fa-phone w-4 text-gray-400"></i> ${dama.telefono}</div>` : ''}
                        ${dama.email ? `<div class="flex items-center gap-2"><i class="fas fa-envelope w-4 text-gray-400"></i> ${dama.email}</div>` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openDamaModal('${dama.id}')" class="flex-1 px-3 py-2 bg-pink-50 text-pink-600 rounded-lg hover:bg-pink-100 transition text-sm"><i class="fas fa-edit mr-1"></i> Editar</button>
                        <button onclick="deleteDama('${dama.id}')" class="px-3 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition text-sm"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function exportarDamasExcel() {
            if (damas.length === 0) {
                showNotification('No hay damas para exportar', 'error');
                return;
            }
            
            const datos = damas.map(d => ({
                'Nombre': d.nombre,
                'Apellido': d.apellido,
                'Telefono': d.telefono,
                'Email': d.email,
                'Cargo': d.cargo,
                'Estado': d.estado,
                'Fecha Ingreso': d.ingreso,
                'Direccion': d.direccion,
                'Notas': d.notas
            }));
            
            const ws = XLSX.utils.json_to_sheet(datos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Damas");
            XLSX.writeFile(wb, `Registro_Damas_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showNotification('Excel descargado correctamente', 'success');
        }

        // GESTION DE TESORERIA
        function updateTransaccionForm() {
            const tipo = document.getElementById('transTipo').value;
            const selectCategoria = document.getElementById('transCategoria');
            const selectMiembro = document.getElementById('transMiembro');
            
            const categoriasIngreso = [
                { valor: 'ofrenda', texto: 'Ofrenda' },
                { valor: 'diezmo', texto: 'Diezmo' },
                { valor: 'donacion', texto: 'Donacion Especial' },
                { valor: 'evento', texto: 'Evento/Actividad' },
                { valor: 'cuota', texto: 'Cuota Membresia' },
                { valor: 'otro', texto: 'Otro Ingreso' }
            ];
            
            const categoriasEgreso = [
                { valor: 'alquiler', texto: 'Alquiler Local' },
                { valor: 'servicios', texto: 'Servicios (Luz, Agua, etc)' },
                { valor: 'materiales', texto: 'Materiales/Utensilios' },
                { valor: 'evento', texto: 'Gasto de Evento' },
                { valor: 'donacion', texto: 'Donacion a Obras' },
                { valor: 'otro', texto: 'Otro Egreso' }
            ];
            
            const categorias = tipo === 'ingreso' ? categoriasIngreso : categoriasEgreso;
            
            selectCategoria.innerHTML = categorias.map(cat => `<option value="${cat.valor}">${cat.texto}</option>`).join('');
            
            selectMiembro.innerHTML = '<option value="">Seleccionar dama...</option>' +
                damas.map(d => `<option value="${d.id}">${d.nombre} ${d.apellido}</option>`).join('');
        }

        function openTransaccionModal() {
            document.getElementById('transaccionForm').reset();
            document.getElementById('transFecha').value = new Date().toISOString().split('T')[0];
            updateTransaccionForm();
            document.getElementById('transaccionModal').classList.remove('hidden');
        }

        function closeTransaccionModal() {
            document.getElementById('transaccionModal').classList.add('hidden');
        }

        function saveTransaccion(event) {
            event.preventDefault();
            
            const transaccion = {
                id: Date.now().toString(),
                tipo: document.getElementById('transTipo').value,
                fecha: document.getElementById('transFecha').value,
                monto: parseFloat(document.getElementById('transMonto').value),
                concepto: document.getElementById('transConcepto').value,
                categoria: document.getElementById('transCategoria').value,
                miembroId: document.getElementById('transMiembro').value,
                notas: document.getElementById('transNotas').value,
                createdAt: new Date().toISOString()
            };
            
            transacciones.push(transaccion);
            localStorage.setItem('transaccionesData', JSON.stringify(transacciones));
            
            closeTransaccionModal();
            updateTesoreriaStats();
            renderTransacciones();
            updateUI();
            showNotification('Transaccion registrada correctamente', 'success');
        }

        function deleteTransaccion(id) {
            if (!confirm('Eliminar esta transaccion?')) return;
            
            transacciones = transacciones.filter(t => t.id !== id);
            localStorage.setItem('transaccionesData', JSON.stringify(transacciones));
            updateTesoreriaStats();
            renderTransacciones();
            updateUI();
            showNotification('Transaccion eliminada', 'info');
        }

        function updateTesoreriaStats() {
            const totalIngresos = transacciones.filter(t => t.tipo === 'ingreso').reduce((sum, t) => sum + t.monto, 0);
            const totalEgresos = transacciones.filter(t => t.tipo === 'egreso').reduce((sum, t) => sum + t.monto, 0);
            const balance = totalIngresos - totalEgresos;
            
            document.getElementById('totalIngresos').textContent = formatMoney(totalIngresos);
            document.getElementById('totalEgresos').textContent = formatMoney(totalEgresos);
            document.getElementById('balanceActual').textContent = formatMoney(balance);
        }

        function renderTransacciones() {
            const tbody = document.getElementById('transaccionesTable');
            const mesFiltro = document.getElementById('filterMonth').value;
            
            let filtradas = transacciones;
            if (mesFiltro) {
                filtradas = transacciones.filter(t => t.fecha.startsWith(mesFiltro));
            }
            
            filtradas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            if (filtradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No hay transacciones en este periodo</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtradas.map(t => {
                const dama = damas.find(d => d.id === t.miembroId);
                const nombreMiembro = dama ? `${dama.nombre} ${dama.apellido}` : 'No especificado';
                const esIngreso = t.tipo === 'ingreso';
                
                return `<tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-600">${formatDate(t.fecha)}</td>
                    <td class="px-4 py-3 font-medium text-gray-800">${t.concepto}</td>
                    <td class="px-4 py-3 text-sm"><span class="px-2 py-1 bg-gray-100 rounded-full text-xs capitalize">${t.categoria}</span></td>
                    <td class="px-4 py-3 text-sm text-gray-600">${nombreMiembro}</td>
                    <td class="px-4 py-3 text-right font-bold ${esIngreso ? 'text-green-600' : 'text-red-600'}">${esIngreso ? '+' : '-'}${formatMoney(t.monto)}</td>
                    <td class="px-4 py-3 text-center"><button onclick="deleteTransaccion('${t.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            }).join('');
        }

        function exportarFinanzas() {
            if (transacciones.length === 0) {
                showNotification('No hay transacciones para exportar', 'error');
                return;
            }
            
            const datos = transacciones.map(t => {
                const dama = damas.find(d => d.id === t.miembroId);
                return {
                    'Fecha': t.fecha,
                    'Tipo': t.tipo,
                    'Concepto': t.concepto,
                    'Categoria': t.categoria,
                    'Monto': t.monto,
                    'Miembro': dama ? `${dama.nombre} ${dama.apellido}` : 'N/A',
                    'Notas': t.notas
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(datos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Finanzas");
            XLSX.writeFile(wb, `Finanzas_Damas_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showNotification('Excel de finanzas descargado', 'success');
        }

        // REPORTES
        function updateReportes() {
            const totalIngresos = transacciones.filter(t => t.tipo === 'ingreso').reduce((sum, t) => sum + t.monto, 0);
            const mesesUnicos = new Set(transacciones.map(t => t.fecha.slice(0, 7))).size;
            const promedioMensual = mesesUnicos > 0 ? totalIngresos / mesesUnicos : 0;
            
            document.getElementById('proyeccionMensual').textContent = formatMoney(promedioMensual);
            document.getElementById('promedioMiembro').textContent = damas.length > 0 ? formatMoney(totalIngresos / damas.length) : '$0';
            document.getElementById('estimadoAnual').textContent = formatMoney(promedioMensual * 12);
            
            const totalEgresos = transacciones.filter(t => t.tipo === 'egreso').reduce((sum, t) => sum + t.monto, 0);
            const balance = totalIngresos - totalEgresos;
            
            document.getElementById('resumenEjecutivo').innerHTML = `
                <p><strong>Estimado Pastor:</strong></p>
                <p class="mt-2">El ministerio de damas cuenta actualmente con <strong>${damas.length} mujeres</strong> registradas, 
                de las cuales <strong>${damas.filter(d => d.estado === 'activa').length} estan activas</strong> en el servicio.</p>
                <p class="mt-2">En el area financiera, hemos registrado un total de <strong>${formatMoney(totalIngresos)} en ingresos</strong> 
                y <strong>${formatMoney(totalEgresos)} en egresos</strong>, 
                dejando un balance de <strong class="${balance >= 0 ? 'text-green-600' : 'text-red-600'}">${formatMoney(balance)}</strong>.</p>
                <p class="mt-2">La proyeccion anual estimada es de <strong>${formatMoney(promedioMensual * 12)}</strong>.</p>
                <p class="mt-4 text-sm text-gray-500">Reporte generado por ${config.nombreTesorera || 'La Tesorera'} 
                el ${new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}.</p>
            `;
            
            updateCharts();
        }

        // GRAFICOS
        let charts = {};
        
        function initCharts() {
            const ctxMini = document.getElementById('miniChart').getContext('2d');
            charts.mini = new Chart(ctxMini, {
                type: 'line',
                data: getChartData(),
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function updateCharts() {
            if (charts.crecimiento) charts.crecimiento.destroy();
            if (charts.categorias) charts.categorias.destroy();
            if (charts.asistencia) charts.asistencia.destroy();
            
            const ctxCrec = document.getElementById('chartCrecimiento').getContext('2d');
            charts.crecimiento = new Chart(ctxCrec, {
                type: 'line',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Nuevas damas',
                        data: [2, 3, 5, 4, 6, damas.length],
                        borderColor: '#ec4899',
                        backgroundColor: 'rgba(236, 72, 153, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
            
            const ingresosPorCategoria = {};
            transacciones.filter(t => t.tipo === 'ingreso').forEach(t => {
                ingresosPorCategoria[t.categoria] = (ingresosPorCategoria[t.categoria] || 0) + t.monto;
            });
            
            const ctxCat = document.getElementById('chartCategorias').getContext('2d');
            charts.categorias = new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(ingresosPorCategoria).map(c => c.charAt(0).toUpperCase() + c.slice(1)),
                    datasets: [{
                        data: Object.values(ingresosPorCategoria),
                        backgroundColor: ['#ec4899', '#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444']
                    }]
                },
                options: { responsive: true }
            });
            
            const ctxAsis = document.getElementById('chartAsistencia').getContext('2d');
            charts.asistencia = new Chart(ctxAsis, {
                type: 'bar',
                data: {
                    labels: ['Domingo', 'Martes', 'Jueves', 'Sabado'],
                    datasets: [{
                        label: 'Asistencia estimada',
                        data: [
                            Math.floor(damas.length * 0.4),
                            Math.floor(damas.length * 0.25),
                            Math.floor(damas.length * 0.2),
                            Math.floor(damas.length * 0.35)
                        ],
                        backgroundColor: '#ec4899'
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function getChartData() {
            const datosPorMes = {};
            transacciones.forEach(t => {
                const mes = t.fecha.slice(0, 7);
                if (!datosPorMes[mes]) datosPorMes[mes] = { ingreso: 0, egreso: 0 };
                datosPorMes[mes][t.tipo] += t.monto;
            });
            
            const meses = Object.keys(datosPorMes).slice(-6);
            
            return {
                labels: meses,
                datasets: [
                    {
                        label: 'Ingresos',
                        data: meses.map(m => datosPorMes[m].ingreso),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Egresos',
                        data: meses.map(m => datosPorMes[m].egreso),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            };
        }

        // CONFIGURACION
        function guardarConfig() {
            config.nombreMinisterio = document.getElementById('configNombre').value;
            config.nombreTesorera = document.getElementById('configTesorera').value;
            config.moneda = document.getElementById('configMoneda').value;
            
            localStorage.setItem('damasConfig', JSON.stringify(config));
            updateMonedaSymbol();
            showNotification('Configuracion guardada correctamente', 'success');
        }

        function updateMonedaSymbol() {
            const simbolos = { USD: '$', MXN: '$', COP: '$', ARS: '$', EUR: '' };
            document.getElementById('transMonedaSymbol').textContent = simbolos[config.moneda] || '$';
        }

        function backupCompleto() {
            const datos = {
                damas: damas,
                transacciones: transacciones,
                config: config,
                fechaExportacion: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_damas_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Respaldo descargado correctamente', 'success');
        }

        // UPGRADE Y UTILIDADES
        function showUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('hidden');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('hidden');
        }

        function simulateUpgrade() {
            isPro = true;
            localStorage.setItem('damasPro', 'true');
            closeUpgradeModal();
            updateUI();
            showNotification('Felicidades! Ahora tienes DamasPro Premium', 'success');
        }

        function formatMoney(cantidad) {
            const simbolos = { USD: '$', MXN: '$', COP: '$', ARS: '$', EUR: '' };
            const simbolo = simbolos[config.moneda] || '$';
            return simbolo + parseFloat(cantidad).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function formatDate(fechaString) {
            const fecha = new Date(fechaString);
            return fecha.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function showNotification(mensaje, tipo) {
            const div = document.createElement('div');
            const colores = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            div.className = `fixed bottom-4 right-4 ${colores[tipo]} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in flex items-center gap-2`;
            div.innerHTML = `<i class="fas fa-${tipo === 'success' ? 'check' : tipo === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i><span>${mensaje}</span>`;
            
            document.body.appendChild(div);
            
            setTimeout(() => {
                div.remove();
            }, 3000);
        }

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            if (event.target.id === 'damaModal') closeDamaModal();
            if (event.target.id === 'transaccionModal') closeTransaccionModal();
            if (event.target.id === 'upgradeModal') closeUpgradeModal();
        }
    </script>
</body>
</html>
